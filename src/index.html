<!DOCTYPE html>
<html lang="en">
  <head>
    <script>
      // Suppress browser extension errors as early as possible
      (function() {
        const originalError = window.Error;
        const originalEval = window.eval;
        
        // Override Error constructor to catch extension errors
        window.addEventListener('error', function(e) {
          if (e.filename && (e.filename.includes('inject-script') || e.filename.includes('extension://') || e.filename.includes('VM'))) {
            e.preventDefault();
            e.stopPropagation();
            return false;
          }
        }, true); // Use capture phase
        
        // Suppress console errors from extensions
        const originalConsoleError = console.error;
        console.error = function(...args) {
          const errorString = args.join(' ');
          if (errorString.includes('foregroundEntryPoint') || 
              errorString.includes('inject-script') ||
              errorString.includes('extension://')) {
            return;
          }
          originalConsoleError.apply(console, args);
        };
      })();
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="theme-color" content="#000000" />
    
    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://ajax.googleapis.com" />
    <link rel="preconnect" href="https://tile.googleapis.com" />
    
    <link rel="stylesheet" type="text/css" href="./main.css" />
    <link rel="stylesheet" type="text/css" href="./styles/chapters.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/cesiumjs/1.105/Build/Cesium/Cesium.js"></script>
    <link
      href="https://ajax.googleapis.com/ajax/libs/cesiumjs/1.105/Build/Cesium/Widgets/widgets.css"
      rel="stylesheet"
    />
    <title>Explorar España - 3D Interactive Story</title>
  </head>
  <body>
    <!-- Loading screen -->
    <div id="loading-screen" class="loading-screen">
      <div class="loading-content">
        <img src="assets/IIE-logo.png" alt="IIE Logo" class="loading-logo">
        <div class="loading-text">Explorar España</div>
        <div class="loading-spinner"></div>
      </div>
    </div>
    <!-- Top navigation container with logo and places -->
    <div id="top-navigation-container">
      <div class="organization-logo">
        <img src="assets/IIE-logo.png" alt="IIE Logo" />
      </div>
      
      <div id="top-navigation-bar">
      <button class="nav-scroll-btn prev" onclick="scrollPlaces('prev')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <div id="places-scroll-container">
        <div id="places-list"></div>
      </div>
      <button class="nav-scroll-btn next" onclick="scrollPlaces('next')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      </div>
    </div>
    
    <!-- Mobile overlay -->
    <div id="mobile-overlay" class="mobile-overlay" onclick="toggleMobilePlaces()"></div>
    
    <!-- Mobile places toggle button -->
    <button id="mobile-places-toggle" class="mobile-places-toggle" onclick="toggleMobilePlaces()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
        <path d="M3 12H21M3 6H21M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    
    <!-- Orbit pause button -->
    <button id="orbit-pause-btn" class="orbit-pause-btn" onclick="toggleOrbitPause()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
        <path id="pause-icon" d="M6 4H8V20H6V4ZM16 4H18V20H16V4Z" fill="currentColor"/>
        <path id="play-icon" d="M8 5V19L19 12L8 5Z" fill="currentColor" style="display: none;"/>
      </svg>
    </button>
    
    <!-- Bottom sheet for chapter details -->
    <div id="bottom-sheet" class="bottom-sheet">
      <div class="bottom-sheet-handle" onclick="toggleBottomSheet()">
        <div class="handle-bar"></div>
      </div>

      <button class="fullscreen-btn" onclick="toggleFullscreen()" title="Pantalla completa">
        <svg class="fullscreen-expand" width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M8 3H5C3.89 3 3 3.89 3 5V8M21 8V5C21 3.89 20.11 3 19 3H16M16 21H19C20.11 21 21 20.11 21 19V16M8 21H5C3.89 21 3 20.11 3 19V16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <svg class="fullscreen-collapse" width="18" height="18" viewBox="0 0 24 24" fill="none" style="display: none;">
          <path d="M8 3V6C8 7.11 8.89 8 10 8H13M16 21V18C16 16.89 16.89 16 18 16H21M21 8H18C16.89 8 16 8.89 16 10V13M3 16H6C7.11 16 8 16.89 8 18V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>

      <!-- Photo Gallery Section -->
      <div class="photo-gallery">
        <div class="gallery-container">
          <div class="gallery-track" id="gallery-track">
            <!-- Images will be populated dynamically -->
          </div>
          <button class="gallery-nav gallery-prev" onclick="navigateGallery(-1)">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
              <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <button class="gallery-nav gallery-next" onclick="navigateGallery(1)">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
              <path d="M9 18L15 12L9 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
        <div class="gallery-dots" id="gallery-dots">
          <!-- Dots will be populated dynamically -->
        </div>
        <div class="image-credit" id="image-credit">
          <!-- Image credits will be shown here -->
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <button class="tab-btn active" data-tab="info" onclick="switchTab('info')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M12 2L2 7V10C2 16 6 20.5 12 22C18 20.5 22 16 22 10V7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Información</span>
        </button>
        <button class="tab-btn" data-tab="resources" onclick="switchTab('resources')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M6.5 2H20V22H6.5A2.5 2.5 0 0 1 4 19.5V4.5A2.5 2.5 0 0 1 6.5 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Recursos</span>
        </button>
        <button class="tab-btn" data-tab="links" onclick="switchTab('links')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M10 13A5 5 0 0 0 14.54 18.54L16.36 16.73A2.828 2.828 0 1 1 20.36 12.73L18.54 10.91A5 5 0 0 0 13 15.36L10.91 17.18A2.828 2.828 0 1 1 6.91 21.18L5.09 19.36A5 5 0 0 0 10 13V13Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Enlaces</span>
        </button>
      </div>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Information Tab -->
        <div class="tab-panel active" id="info-panel">
          <div class="info-header">
            <h2 class="place-title"></h2>
            <div class="place-location">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path d="M21 10C21 17 12 23 12 23S3 17 3 10C3 6.13 6.13 3 12 3S21 6.13 21 10Z" stroke="currentColor" stroke-width="2"/>
                <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="2"/>
              </svg>
              <span class="place-address"></span>
            </div>
            <div class="place-period">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <span class="place-date"></span>
            </div>
          </div>
          <div class="info-description">
            <p class="place-description"></p>
          </div>
        </div>

        <!-- Resources Tab -->
        <div class="tab-panel" id="resources-panel">
          <div class="resources-content">
            <div class="resource-section">
              <h3>Información Práctica</h3>
              <div class="resource-list">
                <div class="resource-item">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  <div>
                    <span class="resource-label">Horarios</span>
                    <span class="resource-value">Consultar sitio web oficial</span>
                  </div>
                </div>
                <div class="resource-item">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M12 2L12 22M17 5H9.5A3.5 3.5 0 0 0 9.5 12H17M17 12H9.5A3.5 3.5 0 0 0 9.5 19H17" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  <div>
                    <span class="resource-label">Precios</span>
                    <span class="resource-value">Ver información oficial</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Links Tab -->
        <div class="tab-panel" id="links-panel">
          <div class="links-content">
            <div class="links-section">
              <h3>Enlaces Oficiales</h3>
              <div class="links-list" id="official-links">
                <!-- Links will be populated dynamically -->
              </div>
            </div>
            <div class="links-section">
              <h3>Información Turística</h3>
              <div class="links-list">
                <a href="https://www.spain.info" target="_blank" class="link-item">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M18 13V6A2 2 0 0 0 16 4H4A2 2 0 0 0 2 6V18C2 19.1 2.9 20 4 20H20A2 2 0 0 0 22 18V8H18" stroke="currentColor" stroke-width="2"/>
                    <path d="M15 3H21V9M10 14L21 3" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  <div>
                    <span class="link-title">Spain.info</span>
                    <span class="link-desc">Portal oficial de turismo de España</span>
                  </div>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="map-container">
      <div id="cesium-container"></div>
    </div>

    <!-- Chatbot Container -->
    <button id="chat-toggle-btn" onclick="toggleChat()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2ZM20 16H5.17L4 17.17V4H20V16Z" fill="white"/>
        <path d="M7 9H17V11H7V9ZM7 6H17V8H7V6ZM7 12H14V14H7V12Z" fill="white"/>
      </svg>
    </button>

    <div id="chat-container">
      <div class="chat-header">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20Z" fill="white"/>
          <path d="M15.5 11C16.33 11 17 10.33 17 9.5C17 8.67 16.33 8 15.5 8C14.67 8 14 8.67 14 9.5C14 10.33 14.67 11 15.5 11ZM8.5 11C9.33 11 10 10.33 10 9.5C10 8.67 9.33 8 8.5 8C7.67 8 7 8.67 7 9.5C7 10.33 7.67 11 8.5 11ZM12 17.5C14.33 17.5 16.31 16.04 17.11 14H6.89C7.69 16.04 9.67 17.5 12 17.5Z" fill="white"/>
        </svg>
        <span>Asistente de Exploración</span>
      </div>
      <div id="chat-messages"></div>
      <div class="chat-input-container">
        <input type="text" id="chat-input" placeholder="Busca un lugar... (ej: Alhambra, Palacio Real)" />
        <button id="chat-send-btn" onclick="sendMessage()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z" fill="white"/>
          </svg>
        </button>
      </div>
    </div>

    <script type="module" src="./main.js"></script>

  </body>
</html>
