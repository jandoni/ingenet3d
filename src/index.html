<!DOCTYPE html>
<html lang="en">
  <head>
    <script>
      // Suppress browser extension errors as early as possible
      (function() {
        const originalError = window.Error;
        const originalEval = window.eval;
        
        // Override Error constructor to catch extension errors
        window.addEventListener('error', function(e) {
          if (e.filename && (e.filename.includes('inject-script') || e.filename.includes('extension://') || e.filename.includes('VM'))) {
            e.preventDefault();
            e.stopPropagation();
            return false;
          }
        }, true); // Use capture phase
        
        // Suppress console errors from extensions
        const originalConsoleError = console.error;
        console.error = function(...args) {
          const errorString = args.join(' ');
          if (errorString.includes('foregroundEntryPoint') || 
              errorString.includes('inject-script') ||
              errorString.includes('extension://')) {
            return;
          }
          originalConsoleError.apply(console, args);
        };
      })();
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="theme-color" content="#000000" />

    <!-- Favicons - Instituto de la Ingeniería de España -->
    <link rel="icon" type="image/png" sizes="32x32" href="assets/IIE-logo.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="assets/IIE-logo.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="assets/IIE-logo.png" />
    <link rel="shortcut icon" href="assets/IIE-logo.png" />

    <!-- DNS Prefetch - Resolve DNS early for third-party domains -->
    <link rel="dns-prefetch" href="https://ajax.googleapis.com" />
    <link rel="dns-prefetch" href="https://tile.googleapis.com" />
    <link rel="dns-prefetch" href="https://www.google.com" />

    <!-- Preconnect - Establish early connections to critical origins -->
    <link rel="preconnect" href="https://ajax.googleapis.com" crossorigin />
    <link rel="preconnect" href="https://tile.googleapis.com" crossorigin />

    <!-- Preload critical fonts - Load immediately for faster text rendering -->
    <link rel="preload" href="assets/fonts/Inter-Regular.ttf" as="font" type="font/ttf" crossorigin />
    <link rel="preload" href="assets/fonts/New-York.ttf" as="font" type="font/ttf" crossorigin />

    <!-- Preload critical images - Load logo immediately for loading screen -->
    <link rel="preload" href="assets/IIE-logo.webp" as="image" type="image/webp" />
    <link rel="preload" href="assets/IIE-logo.png" as="image" type="image/png" />

    <!-- Preload critical CSS for faster rendering -->
    <link rel="preload" href="./main.css" as="style" />
    <link rel="preload" href="https://ajax.googleapis.com/ajax/libs/cesiumjs/1.105/Build/Cesium/Widgets/widgets.css" as="style" />

    <link rel="stylesheet" type="text/css" href="./main.css" />
    <link rel="stylesheet" type="text/css" href="./styles/chapters.css" />

    <!-- Cesium script with defer - downloads in parallel, executes before modules -->
    <script defer src="https://ajax.googleapis.com/ajax/libs/cesiumjs/1.105/Build/Cesium/Cesium.js"></script>
    <link
      href="https://ajax.googleapis.com/ajax/libs/cesiumjs/1.105/Build/Cesium/Widgets/widgets.css"
      rel="stylesheet"
    />
    <title>Explorar España - Instituto de la Ingeniería de España</title>
  </head>
  <body>
    <!-- Loading screen -->
    <div id="loading-screen" class="loading-screen">
      <div class="loading-content">
        <picture>
          <source srcset="assets/IIE-logo.webp" type="image/webp">
          <img src="assets/IIE-logo.png" alt="IIE Logo" class="loading-logo">
        </picture>
        <div class="loading-text">Explorar España</div>
        <div class="loading-spinner"></div>
        <div class="loading-progress">
          <div class="loading-status">Inicializando...</div>
          <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar"></div>
          </div>
          <div class="loading-percentage">0%</div>
        </div>
      </div>
    </div>
    <!-- Top navigation container with logo and places -->
    <div id="top-navigation-container">
      <div class="organization-logo" onclick="goToHome()" style="cursor: pointer;" title="Volver al inicio">
        <picture>
          <source srcset="assets/IIE-logo.webp" type="image/webp">
          <img src="assets/IIE-logo.png" alt="IIE Logo" />
        </picture>
      </div>
      
      <div id="top-navigation-bar">
      <button class="nav-scroll-btn prev" onclick="scrollPlaces('prev')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <div id="places-scroll-container">
        <div id="places-list"></div>
      </div>
      <button class="nav-scroll-btn next" onclick="scrollPlaces('next')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      </div>
    </div>
    
    <!-- Mobile overlay -->
    <div id="mobile-overlay" class="mobile-overlay" onclick="toggleMobilePlaces()"></div>
    
    <!-- Mobile places toggle button -->
    <button id="mobile-places-toggle" class="mobile-places-toggle" onclick="toggleMobilePlaces()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
        <path d="M3 12H21M3 6H21M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    
    <!-- Orbit pause button -->
    <button id="orbit-pause-btn" class="orbit-pause-btn" onclick="toggleOrbitPause()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
        <path id="pause-icon" d="M6 4H8V20H6V4ZM16 4H18V20H16V4Z" fill="currentColor"/>
        <path id="play-icon" d="M8 5V19L19 12L8 5Z" fill="currentColor" style="display: none;"/>
      </svg>
    </button>

    <!-- Zoom controls -->
    <div class="zoom-controls">
      <button id="zoom-in-btn" class="zoom-btn" onclick="zoomIn()" title="Acercar">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
      <button id="zoom-out-btn" class="zoom-btn" onclick="zoomOut()" title="Alejar">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
      <button id="home-btn" class="zoom-btn" onclick="goToHome()" title="Inicio">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M9 22V12H15V22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>

    <!-- Controls info box -->
    <div class="controls-info">
      <div class="controls-title">Controles</div>
      <div class="control-item">
        <div class="control-text">
          <strong>Rotar:</strong> Clic izquierdo + arrastrar
        </div>
      </div>
      <div class="control-item">
        <div class="control-text">
          <strong>Mover:</strong> Shift + clic izquierdo + arrastrar
        </div>
      </div>
      <div class="control-item">
        <div class="control-text">
          <strong>Zoom:</strong> Rueda del ratón<br/>
          <span style="font-size: 11px; color: #64748b;">o deslizar dos dedos en trackpad</span>
        </div>
      </div>
    </div>

    <!-- Bottom sheet for chapter details -->
    <div id="bottom-sheet" class="bottom-sheet">
      <div class="bottom-sheet-handle" onclick="toggleBottomSheet()">
        <div class="handle-bar"></div>
      </div>

      <button class="fullscreen-btn" onclick="toggleFullscreen()" title="Pantalla completa">
        <svg class="fullscreen-expand" width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M8 3H5C3.89 3 3 3.89 3 5V8M21 8V5C21 3.89 20.11 3 19 3H16M16 21H19C20.11 21 21 20.11 21 19V16M8 21H5C3.89 21 3 20.11 3 19V16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <svg class="fullscreen-collapse" width="18" height="18" viewBox="0 0 24 24" fill="none" style="display: none;">
          <path d="M8 3V6C8 7.11 8.89 8 10 8H13M16 21V18C16 16.89 16.89 16 18 16H21M21 8H18C16.89 8 16 8.89 16 10V13M3 16H6C7.11 16 8 16.89 8 18V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>

      <!-- Photo Gallery Section -->
      <div class="photo-gallery">
        <div class="gallery-container">
          <div class="gallery-track" id="gallery-track">
            <!-- Images will be populated dynamically -->
          </div>
          <button class="gallery-nav gallery-prev" onclick="navigateGallery(-1)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <button class="gallery-nav gallery-next" onclick="navigateGallery(1)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
        <div class="gallery-dots" id="gallery-dots">
          <!-- Dots will be populated dynamically -->
        </div>
        <div class="image-credit" id="image-credit">
          <!-- Image credits will be shown here -->
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <button class="tab-btn active" data-tab="info" onclick="switchTab('info')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M12 2L2 7V10C2 16 6 20.5 12 22C18 20.5 22 16 22 10V7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Información</span>
        </button>
        <button class="tab-btn" data-tab="links" onclick="switchTab('links')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M10 13A5 5 0 0 0 14.54 18.54L16.36 16.73A2.828 2.828 0 1 1 20.36 12.73L18.54 10.91A5 5 0 0 0 13 15.36L10.91 17.18A2.828 2.828 0 1 1 6.91 21.18L5.09 19.36A5 5 0 0 0 10 13V13Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Enlaces</span>
        </button>
      </div>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Information Tab -->
        <div class="tab-panel active" id="info-panel">
          <div class="info-header">
            <h2 class="place-title"></h2>
            <div class="place-location">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path d="M21 10C21 17 12 23 12 23S3 17 3 10C3 6.13 6.13 3 12 3S21 6.13 21 10Z" stroke="currentColor" stroke-width="2"/>
                <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="2"/>
              </svg>
              <span class="place-address"></span>
            </div>
            <div class="place-period">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <span class="place-date"></span>
            </div>
          </div>
          <div class="info-description">
            <p class="place-description"></p>
          </div>
        </div>


        <!-- Links Tab -->
        <div class="tab-panel" id="links-panel">
          <div class="links-content">
            <div class="links-section">
              <h3>Enlaces Oficiales</h3>
              <div class="links-list" id="official-links">
                <!-- Links will be populated dynamically -->
              </div>
            </div>

            <div class="links-section">
              <h3>Etiquetas</h3>
              <div class="tags-container">
                <div class="tag-category">
                  <h4>Ubicación</h4>
                  <div class="tags-list" id="location-tags">
                    <!-- Location tags will be populated dynamically -->
                  </div>
                </div>

                <div class="tag-category">
                  <h4>Sector</h4>
                  <div class="tags-list" id="sector-tags">
                    <!-- Sector tags will be populated dynamically -->
                  </div>
                </div>

                <div class="tag-category">
                  <h4>Profesión</h4>
                  <div class="tags-list" id="profession-tags">
                    <!-- Profession tags will be populated dynamically -->
                  </div>
                </div>

                <div class="tag-category">
                  <h4>Tipo</h4>
                  <div class="tags-list" id="type-tags">
                    <!-- Type tags will be populated dynamically -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="map-container">
      <div id="cesium-container"></div>
    </div>

    <!-- Chatbot Container -->
    <button id="chat-toggle-btn" onclick="toggleChat()">
      <picture>
        <source srcset="assets/robot.webp" type="image/webp">
        <img src="assets/robot.png" alt="Robot Assistant" class="robot-icon" loading="lazy">
      </picture>
      <div class="chat-bubble">
        ¡Úsame para buscar organizaciones de tu campo profesional!
      </div>
    </button>

    <div id="chat-container">
      <div class="chat-header">
        <span>Asistente de Exploración</span>
      </div>
      <div id="chat-messages"></div>
      <div class="chat-input-container">
        <input type="text" id="chat-input" placeholder="Busca un lugar... (ej: Alhambra, Palacio Real)" />
        <button id="chat-send-btn" onclick="sendMessage()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z" fill="white"/>
          </svg>
        </button>
      </div>
    </div>

    <script type="module" src="./main.js"></script>

  </body>
</html>
